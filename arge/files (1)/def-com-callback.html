<!DOCTYPE html>
<html>
<head>
  <title>DEF.COM - GiriÅŸ Ä°ÅŸleniyor</title>
</head>
<body>
  <h1>ğŸ”„ DEF.COM'a GiriÅŸ YapÄ±lÄ±yor...</h1>
  <div id="result"></div>

  <script>
    /**
     * URL fragment'ten token'larÄ± al
     * URL: def.com/#token=eyJ...&refresh=eyJ...&device=device_123
     */
    function getTokensFromUrl() {
      const hash = window.location.hash.substring(1); // '#' kaldÄ±r
      const params = new URLSearchParams(hash);

      return {
        accessToken: params.get('token'),
        refreshToken: params.get('refresh'),
        deviceId: params.get('device')
      };
    }

    async function authenticateFromToken() {
      try {
        const { accessToken, refreshToken, deviceId } = getTokensFromUrl();

        if (!accessToken || !refreshToken) {
          document.getElementById('result').innerHTML = `
            âŒ Token bulunamadÄ±<br>
            <a href="https://abc.com/login">ABC.COM'da GiriÅŸ Yap â†’</a>
          `;
          return;
        }

        // Token'larÄ± localStorage'a kaydet
        localStorage.setItem('accessToken', accessToken);
        localStorage.setItem('refreshToken', refreshToken);
        localStorage.setItem('deviceId', deviceId);

        // Token doÄŸrudan auth service'e sor
        const AUTH_SERVICE = 'https://auth-service.com';
        const response = await fetch(`${AUTH_SERVICE}/api/auth/me`, {
          headers: {
            'Authorization': `Bearer ${accessToken}`
          },
          credentials: 'include'
        });

        const user = await response.json();

        if (response.ok) {
          document.getElementById('result').innerHTML = `
            âœ… DEF.COM'da GiriÅŸ BaÅŸarÄ±lÄ±!<br>
            <br>
            HoÅŸgeldiniz, <strong>${user.name}</strong>!<br>
            Email: ${user.email}<br>
            <br>
            <a href="/dashboard">Dashboard'a Git â†’</a>
          `;

          // URL'den fragment'i sil (temizlik)
          window.history.replaceState({}, document.title, window.location.pathname);

          // 2 saniye sonra dashboard'a git
          setTimeout(() => {
            window.location.href = '/dashboard';
          }, 2000);
        } else {
          throw new Error('Token doÄŸrulamasÄ± baÅŸarÄ±sÄ±z');
        }
      } catch (error) {
        document.getElementById('result').innerHTML = `
          âŒ Hata: ${error.message}<br>
          <a href="https://abc.com/login">Tekrar GiriÅŸ Yap â†’</a>
        `;
      }
    }

    // Sayfa yÃ¼klendiÄŸinde Ã§alÄ±ÅŸtÄ±r
    window.onload = authenticateFromToken;
  </script>
</body>
</html>